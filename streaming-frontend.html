<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Minimal SSE Streaming</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 900px;
      margin: 24px auto;
    }

    textarea {
      width: 100%;
      height: 80px;
    }

    pre {
      background: #f5f5f5;
      padding: 12px;
      overflow: auto;
      min-height: 120px;
    }

    .row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    button {
      padding: 8px 12px;
    }

    .pill {
      padding: 2px 8px;
      border-radius: 999px;
      background: #eee;
    }
  </style>
</head>

<body>
  <h2>Minimal LLMâ€‘style streaming</h2>

  <label>Input</label>
  <textarea id="text">hello streaming world</textarea>

  <div class="row">
    <label>delay_ms <input id="delay" type="number" value="60" min="0" max="2000"></label>
    <label><input id="resume" type="checkbox"> resume</label>
    <button id="btnStream">Start stream</button>
    <button id="btnStop" disabled>Stop</button>
    <span class="pill" id="resumePill" style="display:none">resume id: <span id="resumeId"></span></span>
    <span class="pill" id="statusPill">idle</span>
  </div>

  <h3>Streaming output</h3>
  <pre id="out"></pre>

  <script>
    const el = (id) => document.getElementById(id);
    let aborter = null;
    let lastEventId = null;

    function setStatus(s) {
      el("statusPill").textContent = s;
    }

    function resetUI() {
      el("out").textContent = "";
      setStatus("idle");
      lastEventId = null;
      el("resumePill").style.display = "none";
    }

    function startStream() {
      const resuming = el("resume").checked && lastEventId !== null;
      if (!resuming) resetUI();
      setStatus(resuming ? "resuming" : "connecting");
      el("btnStream").disabled = true;

      const url = "http://127.0.0.1:8000/stream";
      const payload = {
        text: el("text").value,
        delay_ms: Number(el("delay").value),
      };

      aborter = new AbortController();
      el("btnStop").disabled = false;
      const headers = { "Content-Type": "application/json" };
      if (resuming) headers["Last-Event-ID"] = String(lastEventId);

      // EventSource only supports GET, so we use fetch + ReadableStream
      fetch(url, {
        method: "POST",
        headers,
        body: JSON.stringify(payload),
        signal: aborter.signal,
      }).then(async (res) => {
        if (!res.ok || !res.body) {
          setStatus("error");
          el("out").textContent = `HTTP ${res.status}`;
          el("btnStream").disabled = false;
          return;
        }

        setStatus("streaming");
        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let buffer = "";

        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          buffer += decoder.decode(value, { stream: true });

          // SSE frames end with \n\n
          let idx;
          while ((idx = buffer.indexOf("\n\n")) !== -1) {
            const frame = buffer.slice(0, idx);
            buffer = buffer.slice(idx + 2);
            handleSseFrame(frame);
          }
        }
        el("btnStop").disabled = true;
        el("btnStream").disabled = false;
        aborter = null;
      }).catch(() => {
        if (aborter && aborter.signal.aborted) {
          setStatus("stopped");
        } else {
          setStatus("error");
          el("out").textContent += "\n[network error]";
        }
        el("btnStop").disabled = true;
        el("btnStream").disabled = false;
        aborter = null;
      });
    }

    function handleSseFrame(frame) {
      const lines = frame.split("\n");
      let event = "message";
      let data = "";
      let eventId = null;

      for (const line of lines) {
        if (line.startsWith("event:")) event = line.slice(6).trim();
        if (line.startsWith("data:")) data = line.slice(5).trim();
        if (line.startsWith("id:")) eventId = Number(line.slice(3).trim());
      }

      if (!data) return;
      const payload = JSON.parse(data);

      if (Number.isFinite(eventId)) lastEventId = eventId;
      if (lastEventId !== null) {
        el("resumeId").textContent = String(lastEventId);
        el("resumePill").style.display = "inline-block";
      }

      if (event === "token") {
        el("out").textContent += payload.token;
      } else if (event === "done") {
        setStatus(`done (${payload.tokens} tokens, ${payload.elapsed_ms} ms)`);
        el("btnStop").disabled = true;
        lastEventId = null;
        el("resumePill").style.display = "none";
        el("btnStream").disabled = false;
      } else if (event === "ping") {
        // ignore
      }
    }

    function stopStream() {
      if (aborter) aborter.abort();
      if (!el("resume").checked) {
        lastEventId = null;
        el("resumePill").style.display = "none";
      }
    }

    el("btnStream").onclick = startStream;
    el("btnStop").onclick = stopStream;
  </script>
</body>

</html>